---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Load packages
#install.packages("tidyr")
library(tidyr)
#install.packages("tidyverse")
library(tidyverse)
#install.packages("readr")
library(readr)
#install.packages("PortfolioAnalytics")
library(PortfolioAnalytics)
#install.packages("ROI")
library(ROI)
#install.packages("ROI.plugin.quadprog")
library(ROI.plugin.quadprog)
#install.packages("ROI.plugin.glpk")
library(ROI.plugin.glpk)
#install.packages('quantmod')
#install.packages('TTR')
library('TTR')
library('quantmod')

library(PerformanceAnalytics)
library(quantmod)
#install.packages("tidyquant")
library(tidyquant)
library(xts) 
library(ggplot2)
#install.packages("highcharter")
library(highcharter)
library(purrr)
library(dplyr)
#install.packages("fredr")
library(fredr)
#install.packages("FSA")
library(FSA)

start_date = "2015-01-01"
end_date = "2020-12-31"
```



```{r}
#API Key = 75711c32cc2177d3a651e1cef5d26d6a
fredr_set_key("75711c32cc2177d3a651e1cef5d26d6a")

# Consumer Price Index for All Urban Consumers: All Items in U.S. City Average (CPIAUCSL)	

CPIAUCSL <- fredr(
  series_id = "CPIAUCSL",
  observation_start = as.Date(start_date),
  observation_end = as.Date(end_date)
)

cpi = subset(CPIAUCSL , select = c(value, date))

ts_cpi = as.xts(cpi)
chart_Series(ts_cpi , name="CPI")
```







Stocks 

Nvidia: "NVDA"
Apple "AAPL"
Google: "GOOG"
Microsoft: "MSFT"
Intel: "INTC"
IBM: "IMB"
SAP: "SAP
Amazon: "AMZN"
Oracle: "ORCL"
Analog Devices: "ADI"
3D Systems Corporation: "DDD"

"NVDA", "AAPL", "GOOG", "MSFT", "INTC", "IMB", "SAP", "AMZN", "ORCL", "ADI", "DDD"


```{r Access to DATA, echo = TRUE}


tickers = c("NVDA", "AAPL", "GOOG", "MSFT", "INTC", "IMB", "SAP", "AMZN", "ORCL", "ADI", "DDD")

df_Assets <- getSymbols(tickers,
           from = start_date,
           to = end_date)

# Ad give you the adjusted prices
# Cl(x) give you the closing price


# Put the prices in one array
prices_df <- purrr::map(tickers, function(x) Cl(get(x)))
prices_df <- purrr::reduce(prices_df,merge)
colnames(prices_df) <- tickers

head(prices_df)

prices_tq <- tq_get(tickers,
                 from = start_date,
                 to = end_date,
                 get = "stock.prices")

#head(prices_tq)

dim(prices_df)


```
```{r}
pr_daily <- getSymbols(tickers, src = "yahoo",
           from = start_date,
           to = end_date,
           auto.assign = TRUE) %>% 
  map(~Ad(get(.))) %>% 
  reduce(merge)

dim(pr_daily)

```

```{r}
rt_daily1 <- na.omit(Return.calculate(pr_daily, method = "log"))
dim(rt_daily1)
rt_daily2 <- na.omit(Return.calculate(prices_df, method = "log"))
dim(rt_daily2)
```

```{r}

#change distrubtion
pw <- rep(1/9, 9)

rt_rebal_qrt <- Return.portfolio(rt_daily1, weights = pw, 
                                    rebalance_on = "weeks")
head(rt_rebal_qrt)

```



```{r}
sd_rt_qrt <- StdDev(rt_rebal_qrt)
sd_rt_qrt

table.DownsideRisk(rt_rebal_qrt)

table.Drawdowns(rt_rebal_qrt)

SharpeRatio(rt_rebal_qrt)

table.Stats(rt_rebal_qrt)

```



```{r Visualise Portfolio Perofrmances, echo = TRUE}

ggplot(data = df, aes(x = date, y = portfolio.returns)) + 
  geom_line(colour = "brown") + 
  scale_x_date(breaks = scales::pretty_breaks(n = 6)) + 
  ggtitle("Returns by Date") + 
  theme(plot.title = element_text(hjust = 0.5)) 

```


```{r Visualise Portfolio Perofrmance 2, echo = TRUE}

df_narrow <- gather(df, key = "Component", value = "Return", -date)
df_narrow[c(1, 143, 285, 427, 569, 711, 853, 995, 1137, 1279),]

bg_df <- filter(df_narrow, Component == "portfolio.returns") %>% 
  select(-Component)
ggplot(data = filter(df_narrow, Component != "portfolio.returns")) +
  geom_line(data = bg_df, aes(x = date, y = Return), colour = "#484848") + 
  geom_line(alpha = 0.6, aes(x = date, y = Return, group = Component, colour = Component)) + 
  facet_wrap(~Component) + theme_bw() + 
  theme(legend.position = "none") 
```

